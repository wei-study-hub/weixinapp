<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; chaRset=utf-8" />
<meta name="author" content=" HouYanPing" /> 
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
	<title>课程详情</title>
	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="css/styles.css">
	<link rel="stylesheet" href="css/weui.css"/>
</head>
<body style="background-color: #f1f1f1;">
<form id="orderpay">
<div class="top">
	<div class="uptop">
		<span class="check checked tl">订单待支付</span>
		<span class="check tc">订单进行中</span>
		<span class="check tr">订单已完成</span>
		<span class="line"></span>
		<em class="checked fn18 tl">●</em>
		<em class="fn18 tc">●</em>
		<em class="fn18 tr">●</em>
	</div>
</div>
<div class="center pdo0">
	<div class="titleh2 h48" >
		活动详情
	</div>  
	<input type="hidden" id="activityCode"></input>
	<input type="hidden" id="scopeTypeCode"></input>
	<input type="hidden" id="studentCode"></input>
	<input type="hidden" id="userCode"></input>      
	<input type="hidden" id="couponCode"></input> 
	<div class="texth4 h48">
		<span class="left" >课程名称</span>
		<span class="right" id="activityName"></span>
	</div>
	<div class="texth4 h72">
		<span class="left">课程时间</span>
		<span class="right" id="classTime"></span>
	</div>
	<div class="texth4 h48">
		<span class="left">课程地点</span>
		<span class="right" id="address"></span>
	</div>
	<!-- <div class="texth4 h48">
		<span class="left">活动价格</span>
		<span class="right" id="price"></span>
	</div> -->
</div>
<div class="center h48">
	<a>
	<div class="texth4 h48 nob">
		<span class="left">&nbsp;&nbsp;&nbsp;&nbsp;学员</span>
		<span class="right selectt">
			<em class="studentName">未选择</em>
			<i> > </i>
			<em class="y" id="selectStudent">选择</em> 
		</span>
	</div>
	</a>
</div>
<!-- <div class="center h48">
	<a>
	<div class="texth4 h48 nob">
		<span class="left">优惠券</span>
		<span class="right selectt">
			<em class="discount">未选择</em>
			<i> > </i>
			<em class="y" id="numCoup"></em> 
		</span>
	</div>
	</a>
</div> -->
<div class="center h48 mb25">
<div class="texth4 h48 nob">
	<span class="left tl">备注</span>
	<span class="right">
		<input style="height:30px;" type="text" placeholder="请填写如年纪等补充说明">
	</span>	
</div>
</div>
<div class="bottomboxed mt25">
	<span class="babtn">免费 <i class="redtex" id="account"></i></span>
	<input class="lvbtn" type="button" onclick="callPay()" value="立即报名"> 
</div>
</form>
<script type="text/javascript" src="js/jquery.min.js"></script>

<script type="text/javascript" src="js/bootstrap.min.js"></script>

<!--点击选择付款方式的样式-->
<script type="text/javascript"> 

function getUrlParam(name) {
    //构造一个含有目标参数的正则表达式对象 
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    //匹配目标参数 
    var r = window.location.search.substr(1).match(reg);
    //返回参数值 
    if (r != null)
      return unescape(r[2]);
    return null;
  }
  
  
/*   function onBridgeReady() {
    var appId = getUrlParam('appId');
    var timeStamp = getUrlParam('timeStamp');
    var nonceStr = getUrlParam('nonceStr');
    var Package = getUrlParam('package');
    var signType = getUrlParam('signType');
    var paySign = getUrlParam('paySign');
    WeixinJSBridge.invoke('getBrandWCPayRequest', {
      "appId" : appId,//"wx2421b1c4370ec43b", //公众号名称，由商户传入   
      "timeStamp" : timeStamp,//"1395712654", //时间戳，自1970年以来的秒数   
      "nonceStr" : nonceStr,//"e61463f8efa94090b1f366cccfbbb444", //随机串   
      "package" : Package,//"prepay_id=u802345jgfjsdfgsdg888",
      "signType" : signType,//"MD5", //微信签名方式:   
      "paySign" : paySign,//"70EA570631E4BB79628FBCA90534C63FF7FADD89" //微信签名 
    }, function(res) { // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回  ok，但并不保证它绝对可靠。  
      //alert(res.err_msg);
      if (res.err_msg == "get_brand_wcpay_request:ok") {
        alert("支付成功");
      }
      if (res.err_msg == "get_brand_wcpay_request:cancel") {
        alert("交易取消");
      }
      if (res.err_msg == "get_brand_wcpay_request:fail") {
        alert("支付失败");
      }
    });
  }
  
  function callPay() {
    if (typeof WeixinJSBridge == "undefined") {
      if (document.addEventListener) {
        document.addEventListener('WeixinJSBridgeReady', onBridgeReady,
            false);
      } else if (document.attachEvent) {
        document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
        document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
      }
    } else {
      onBridgeReady();
    }
  } */
  
    function callPay() {
	  if($('#studentCode').val()==null||$('#studentCode').val()==""){
		  alert("请选择报名的学员");
	  }else{
		$.ajax({
			url : "/yuedong-weixin/order/client/1/createEcourseOrder",
			data : {
				"userCode" : $('#userCode').val(),
				"studentCode" : $('#studentCode').val(),          
				"goodsCode" : $('#activityCode').val()
			
			//	"price":price*100,
			//	"scopeTypeCode":"0"   //$('#scopeTypeCode').val()
			},
			method : "POST", // 设置请求类型为"POST"，默认为"GET"  
			dataType : 'json',
			error : function() { // 设置表单提交出错  
				alert("执行出错");
			},
			success : function(result) {
				if(result.resultCode=='00')
				{
					alert("报名成功");
					window.location.href = "activMy.html?userCode="+$('#userCode').val()+"&type=course";
				}
				else if(result.resultCode=='03')
				{                                                                               
					alert("课程已报名");
				}
				else
				{ 
                    alert("系统异常");
				}
			},
			cache : false
		});
	  }
	} 

    $('.rightridio i').click(function(){
		if ($(this).hasClass('radiobox')) {
			$(this).removeClass('radiobox');
		} else { 
			$(this).addClass('radiobox').parents('.weixinpay').siblings('.weixinpay').find('.rightridio i').removeClass('radiobox')
		}
	})
	$('#selectStudent').click(function(){   
		 window.location.href = "studentinfo.html?userCode="+$('#userCode').val()+'&activityCode='+$('#activityCode').val();
	})      
	$('#numCoup').click(function(){   
		var prices =$('#price').html();
		var price = prices.substr(1,prices.length);
		 window.location.href = "coupons.html?userCode="+$('#userCode').val()+"&scopeTypeCode="+$('#scopeTypeCode').val()+"&price="+price+'&activityCode='+$('#activityCode').val();
	}) 
	function getCous() {
		var prices =$('#price').html();
		var price = prices.substr(1,prices.length);
		$.ajax({
			url : "/yuedong-weixin/coupon/client/1/unusedNum", // 获取优惠劵个数
			data : {
				
				"userCode" : $('#userCode').val(),
				"price":price*100,
				"scopeTypeCode":"0"   //$('#scopeTypeCode').val()
			},
			method : "POST", // 设置请求类型为"POST"，默认为"GET"  
			dataType : 'json',
			error : function() { // 设置表单提交出错  
				alert("执行出错");
			},
			success : function(result) {
				if(result.resultCode=='00')
				{
					$('#numCoup').html('可用'+result.data['couponNum']+'张');
				}else if(result.resultCode=='02')
				{
					
				}else
				{

				}
			},
			cache : false
		});
	}
	$(function() {
		$.ajax({
			url : '/yuedong-weixin/user/get/session',
			type : "POST",
			success : function(data)
			{   
				if(null == data.userCode){
					window.location.href = '/yuedong-weixin/weixin/logined.html';
				}else{
					$("#userCode").val(data.userCode);
					var strUrl = window.location.href;
					var indexof = strUrl.indexOf("?");
					if (indexof != -1) {
						if (strUrl.indexOf('&') != -1) {
							var s = strUrl.substr(strUrl.indexOf("?") + 1,
									strUrl.length)
							var str = s.split('&');
							for (var i = 0; i < str.length; i++) {
								if (str[i].indexOf("activityCode") != -1) {
									strUrl = str[i].substr(str[i].indexOf("=") + 1,
											str[i].length);
									break;
								}
							}
						} else {
							strUrl = strUrl.substr(strUrl.indexOf("=") + 1,
									strUrl.length);
						}
					} else {
						strUrl = null;
					}
					
				/* 	if (null != strUrl) {
						$.ajax({
							url : "/yuedong-weixin/activity/client/1/detail", // 提交的页面  
							data : {
								"activityCode" : strUrl,
								"userCode":$('#userCode').val()
							},
							method : "POST", // 设置请求类型为"POST"，默认为"GET"  
							dataType : 'json',
							error : function() { // 设置表单提交出错  
								alert("执行出错");
							},
							success : function(result) {
								if(result.resultCode=='00')
								{   
									$('#activityName').html(result.data['activityName']);
									$('#price').html("¥"+result.data['price']/100);
									
									$('#address').html(result.data['address']);           
								    $('#classTime').html(result.data['beginTime']+'-'+result.data['endTime']);  
								    $('#activityCode').val(result.data['activityCode']);				
								    $('#scopeTypeCode').val(result.data['scopeTypeCode']); 
									$('#studentCode').val(result.data['studentCode']);
									$('#couponCode').val(result.data['couponCode']);
									if(result.data['studentName']==null||result.data['studentName']==""){
										
									}else{
										$('.studentName').html(result.data['studentName']);
									}
		                            if(result.data['discount']==null||result.data['discount']==""){
										
									}else{
										$('.discount').html(result.data['discount']+"元");
									}
		                            $('#account').html("¥"+(result.data['price']/100-result.data['discount']));
		                            
									
								    getCous();
								       活动唯一编码
									private String activityCode;
								        是否已经收藏
									private String isCollect;
									 
								}else
								{
									alert("服务器异常");
								}
							},
							cache : false
						});
					} */
					if (null != strUrl) {
						$.ajax({
							url  : "/yuedong-weixin/eCourse/client/1/detail", // 提交的页面  
							data : {
								"eCourseCode" : strUrl,
								"userCode":$('#userCode').val()
							},
							method : "POST", // 设置请求类型为"POST"，默认为"GET"  
							dataType : 'json',
							error : function() { // 设置表单提交出错  
								alert("执行出错");
							},
							success : function(result) {
								if(result.resultCode=='00')
								{   
									$('#activityName').html(result.data['courseName']);
							//		$('#price').html("¥"+result.data['price']/100);
									$('#address').html(result.data['address']);           
								    $('#classTime').html(result.data['beginTime']+'-'+result.data['endTime']);  
								    $('#activityCode').val(result.data['courseCode']);				
								    $('#scopeTypeCode').val(result.data['scopeTypeCode']); 
									$('#studentCode').val(result.data['studentCode']);
								//	$('#couponCode').val(result.data['couponCode']);
									if(result.data['studentName']==null||result.data['studentName']==""){
										
									}else{
										$('.studentName').html(result.data['studentName']);
									}
		                            /* if(result.data['discount']==null||result.data['discount']==""){
										
									}else{
										$('.discount').html(result.data['discount']+"元");
									}
		                            $('#account').html("¥"+(result.data['price']/100-result.data['discount'])); */
		                            //  获取优惠劵个数
		                            //  getCous();
								    /*  活动唯一编码
									private String activityCode;
								        是否已经收藏
									private String isCollect;
									 */
								}else
								{
									alert("服务器异常");
								}
							},
							cache : false
						});
					}
				}
				 
			}
		});
	})
</script>
</body>
</html>